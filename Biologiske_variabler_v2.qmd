---
title: "Biologiske variabler_v2"
author: "Marius Émil Lid"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    number-sections: true
    self-contained: true
    code-tools:
      source: true
    keep-md: true
---

### Biologiske variabler oppdatert 25.09

I dette dokumentet undersøker jeg hvordan biologiske variabler endrer seg over tid. Disse variablene er **lengde, vekt, alder, kjønnsratio**.

```{r}
#| label: Bakgrunnskode
#| message: false
#| warning: false
#| echo: false

library(readr)
library(dplyr)
library(sf)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)

# Definer yttergrenser
lon_min <- -21.9
lon_max <- 49.9
lat_min <- 56.9
lat_max <- 77.1

# Lager polygoner av datapunkt som jeg ønsker å fjerne
poly_norway_russia <- st_polygon(list(rbind(
  c(11.4, 57.6),
  c(11.4, 62.8), 
  c(50.0, 62.8),  
  c(50.0, 57.6),  
  c(11.4, 57.6)   
)))

poly_northern_norway <- st_polygon(list(rbind(
  c(23.1, 68.6),
  c(23.1, 68.0),
  c(24.7, 68.0),
  c(24.7, 68.6),
  c(23.1, 68.6)
  
)))

unwanted_datapoints <- st_sfc(poly_northern_norway, poly_norway_russia, crs = 4326)

herring_data <- read_csv("HerringData.csv") |>
  mutate(across(everything(), as.numeric)
  ) |>
  filter(
    !is.na(lat) & !is.na(lon),
    lon >= lon_min & lon <= lon_max,
    lat >= lat_min & lat <= lat_max
  ) 

# omformer fra df til sf
herring_sf <- st_as_sf(herring_data, coords = c("lon", "lat"), crs = 4326)

# Finner og kutter ut datapunkt fra polygonene i det rå datasettet
inside_unwanted_datapoints <- st_intersects(herring_sf, unwanted_datapoints, sparse = FALSE)
# Oppdaterer både sf og df objektene
herring_data <- herring_data[!apply(inside_unwanted_datapoints, 1, any), ]
herring_sf   <- herring_sf[!apply(inside_unwanted_datapoints, 1, any), ]

# Bakgrunnskart
europe <- ne_countries(continent = "Europe", returnclass = "sf")

# Lagrer den fullstendige filen inkludert datasett, grenser og polygoner
save(
  herring_data, herring_sf, lon_min, lon_max, lat_min, lat_max, unwanted_datapoints,
     file = "herring_data_alt.rda")

# Lagrer kun datasettet
saveRDS(herring_data, file = "herring_data.rds")
```

#### Lengde

```{r}
#| label: Variation in Herring Length across Timeperiode (Decade)
#| message: false
#| warning: false

library(dplyr)
library(sf)
library(tidyverse)

herring_data <- readRDS("herring_data.rds")

herring_grouped_decades <- herring_data |> 
  mutate(decade = cut(
    year,
    breaks = c(1935, 1945, 1955, 1965, 1975, 1985, 1995, 2005, 2015, 2019),
    labels = c("1935-1945", "1946-1955", "1956-1965", "1966-1975",
               "1976-1985", "1986-1995", "1996-2005", "2006-2015", "2016-2019"),
    include.lowest = TRUE,  # inkluderer grenseåret 1935
    right = TRUE    #sørger for interval på formen (a,b])
  ))

ggplot(herring_grouped_decades, aes(x = decade, y = length)) +
  geom_boxplot(fill = "skyblue", alpha = 0.6) +
  labs(
    title = "Variation in Herring Length across Timeperiode (Decade)",
    x = "Decade",
    y = "Length (cm)"
  ) +
  theme_minimal()
```

#### Vekt

```{r}
#| label: Variation in Herring Weight by Timeperiode (Decade)
#| message: false
#| warning: false

library(dplyr)
library(sf)
library(tidyverse)

herring_data <- readRDS("herring_data.rds")

herring_decades_weight <- herring_data |> 
  mutate(decade = cut(
    year,
    breaks = c(1935, 1945, 1955, 1965, 1975, 1985, 1995, 2005, 2015, 2019),
    labels = c("1935-1945", "1946-1955", "1956-1965", "1966-1975",
               "1976-1985", "1986-1995", "1996-2005", "2006-2015", "2016-2019"),
    include.lowest = TRUE,  # inkluderer grenseåret 1935
    right = TRUE    #sørger for interval på formen (a,b])
  ))

ggplot(herring_decades_weight, aes(x = decade, y = weight)) +
  geom_boxplot(fill = "pink", alpha = 0.6) +
  labs(
    title = "Variation in Herring Length across Timeperiode (Decade)",
    x = "Decade",
    y = "Weight (gram)"
  ) +
  theme_minimal()
```

#### Alder

```{r}
#| label: Variation in Herring Age across Timeperiode (Decade)
#| message: false
#| warning: false

library(dplyr)
library(sf)
library(tidyverse)

herring_data <- readRDS("herring_data.rds")

herring_decades_age <- herring_data |> 
  mutate(decade = cut(
    year,
    breaks = c(1935, 1945, 1955, 1965, 1975, 1985, 1995, 2005, 2015, 2019),
    labels = c("1935-1945", "1946-1955", "1956-1965", "1966-1975",
               "1976-1985", "1986-1995", "1996-2005", "2006-2015", "2016-2019"),
    include.lowest = TRUE,  # include boundary years
    right = TRUE    #intervales with form (a,b])
  ))

ggplot(herring_decades_age, aes(x = decade, y = age)) +
  geom_boxplot(fill = "lightgrey", alpha = 0.6) +
  labs(
    title = "Variation in Herring Length by Timeperiode (Decade)",
    x = "Decade",
    y = "Age (years)"
  ) +
  scale_y_continuous(n.breaks = 13) + #antall streker på y-akse
  theme_minimal()
```

#### Kjønnsratio

Her starter jeg med å inndele "sex" fra rådata til å vise fordeling av kjønn per år. Deretter viser jeg fordeling av kjønn per tiår over antall individer og kjønnsratio.

I denne koden antar jeg at 1 = hankjønn, 2 = hunkjønn, 4 = feilregistert og NA = ikke registrert.

```{r}
#| message: false
#| warning: false
library(dplyr)
library(tidyr)

#ifelse statement
#https://www.youtube.com/watch?v=zose3lQAN7o
#https://stackoverflow.com/questions/66173100/how-to-use-ifelse-statements-in-r


herring_data <- readRDS("herring_data.rds")

sex_year_wide <- herring_data |>
  mutate(sex_chr = ifelse(is.na(sex), "NA", as.character(sex))) |> # if there is no sex listed, return "NA", else return the data as a character
  group_by(year, sex_chr) |>
  summarise(n = n(), .groups = "drop") |> # teller antall rader 1,2,4 og NA forekommer
  pivot_wider(names_from = sex_chr, values_from = n, values_fill = 0) # Fyller rader som ellers returnerer NA med 0 slik at man summere over radene senere

show(sex_year_wide)
```

I denne koden må jeg endre årstallene utfra sex_year_wider og finne optimale 10 år for å demonstrere trender.

```{r}
#| label: Amount of males and females per decade
#| message: false
#| warning: false

library(dplyr)
library(ggplot2)

herring_data <- readRDS("herring_data.rds")

# Teller antall individer per tiår og fordelt på kjønn
herring_counts <- herring_data |>
  filter(sex %in% c(1, 2)) |>   # beholder kun hankjønn og hunkjønn
  mutate(
    decade = cut(
      year,
      breaks = c(1935, 1945, 1955, 1965, 1975, 1985, 1995, 2005, 2015, 2019),
      labels = c("1935-1945", "1946-1955", "1956-1965", "1966-1975",
                 "1976-1985", "1986-1995", "1996-2005", "2006-2015", "2016-2019"),
      include.lowest = TRUE
    ),
    sex = recode_factor(sex, `1` = "Male", `2` = "Female") # 1 = Male, 2 = Female
  ) |>
  count(decade, sex)   # teller antall rader for hver kombinasjon

# Plot to linjer – en for menn og en for kvinner
ggplot(herring_counts, aes(x = decade, y = n, color = sex, group = sex)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c("Male" = "steelblue", "Female" = "pink1")) +
  labs(
    title = "Amount of males and females per decade",
    x = "Decade",
    y = "Number of individuals",
    color = "Gender"
  ) +
  scale_y_continuous(n.breaks = 20) + #antall streker på y-akse
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45), hjust = 1.5)
```

```{r}
#| message: false
#| warning: false

library(dplyr)
library(sf)
library(tidyverse)

herring_data <- readRDS("herring_data.rds")

herring_ratio_line <- herring_data |>
  filter(sex %in% c(1, 2)) |>
  mutate(
    decade = cut(
      year,
      breaks = c(1935, 1945, 1955, 1965, 1975, 1985, 1995, 2005, 2015, 2019),
      labels = c("1935-1945", "1946-1955", "1956-1965", "1966-1975",
                 "1976-1985", "1986-1995", "1996-2005", "2006-2015", "2016-2019"),
      include.lowest = TRUE)
  ) |>
  group_by(decade) |>
  summarise(
    proportion_males = mean(sex == 1, na.rm = TRUE)
  )

ggplot(herring_ratio_line, aes(x = decade, y = proportion_males, group = 1)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "steelblue", size = 2) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Proportion of males per decade",
    x = "Decade",
    y = "Sex ratio of males (%)"
  ) +
  theme_minimal()
```
